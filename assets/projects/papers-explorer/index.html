<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>All-Conference Papers Explorer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0d10;--panel:#12141a;--muted:#9aa3af;--ink:#e5e7eb;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:24px;margin:0 0 12px}
    .toolbar{display:grid;grid-template-columns:1fr 120px 220px 160px auto;gap:8px;align-items:center}
    .toolbar input,.toolbar select,.toolbar button{
      background:#1a1e26;color:var(--ink);border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px
    }
    .toolbar button{cursor:pointer;background:#2563eb;border-color:#2563eb}
    .toolbar button.secondary{background:#1a1e26;border-color:#2a2f3a}
    .toolbar .full{grid-column:1 / -1}
    .bar{display:flex;gap:10px;align-items:center;margin-top:10px;color:var(--muted);flex-wrap:wrap}
    .count{font-weight:600;color:#cbd5e1}
    .warning{display:none;margin-top:12px;padding:10px 12px;border:1px solid #ef4444;background:#2a1212;color:#fecaca;border-radius:10px;white-space:pre-wrap}
    .list{margin-top:16px;display:grid;grid-template-columns:1fr;gap:10px}
    .card{background:var(--panel);border:1px solid #2a2f3a;border-radius:14px;padding:14px}
    .title{font-size:16px;font-weight:700;margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    .authors{margin-top:6px;color:#cbd5e1}
    .abs{margin-top:8px;color:#d1d5db}
    .links{margin-top:8px;display:flex;gap:12px;flex-wrap:wrap}
    .pill{display:inline-flex;gap:8px;align-items:center}
    .footer{margin-top:24px;color:var(--muted)}
    .spinner{display:none;margin-left:8px;border:2px solid #2a2f3a;border-top:2px solid var(--accent);border-radius:50%;width:16px;height:16px;animation:spin 0.9s linear infinite}
    #dropZone{margin-top:10px;padding:10px;border:1px dashed #2a2f3a;border-radius:10px;color:#9aa3af}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:860px){.toolbar{grid-template-columns:1fr 1fr}.toolbar .full{grid-column:1 / -1}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>All-Conference Papers Explorer</h1>

    <div class="toolbar">
      <input id="q" type="search" placeholder="Search title / author / abstract…" />
      <select id="year">
        <option value="">Year (all)</option>
      </select>
      <input id="venue" type="search" placeholder="Venue contains… e.g. NeurIPS, CVPR"/>
      <select id="sort">
        <option value="relevance">Sort: Relevance</option>
        <option value="year_desc">Sort: Year ↓</option>
        <option value="year_asc">Sort: Year ↑</option>
        <option value="title_asc">Sort: Title A→Z</option>
      </select>
      <button id="btnClear" class="secondary" title="Clear filters">Clear</button>

      <div class="full bar">
        <span id="count" class="count">0 results</span>
        <span id="sources"></span>
        <span id="loading" class="pill">Loading<span class="spinner" id="spin"></span></span>
        <span style="flex:1 1 auto"></span>

        <!-- Dynamic dataset controls -->
        <input id="jsonUrl" type="url" placeholder="JSON URL (same origin)" style="min-width:300px"/>
        <button id="btnLoad">Load</button>
        <input id="jsonFile" type="file" accept=".json,application/json" />
        <label style="display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#9aa3af;">
          <input id="mergeToggle" type="checkbox" />
          Merge (append)
        </label>
        <button id="btnCSV" class="secondary">Download CSV</button>
        <button id="btnDownloadJson" class="secondary">Download JSON</button>
      </div>

      <div id="dropZone" class="full">Drag & drop a JSON file here to load</div>
    </div>

    <div id="warning" class="warning"></div>
    <div id="list" class="list"></div>

    <div class="footer">
      Tip: pass a custom file via <code>?data=/assets/projects/papers-explorer/all_2025_papers.json</code>
    </div>
  </div>

  <script>
  // ---------- Safe coercion helpers ----------
  function toStr(v) { if (v==null) return ""; if (Array.isArray(v)) return v.map(toStr).join(" "); if (typeof v==="object") return JSON.stringify(v); return String(v); }
  function toStrOrNull(v) { const s = toStr(v).trim(); return s ? s : null; }
  function toAuthors(v) { if (Array.isArray(v)) return v.map(toStr).filter(Boolean); if (typeof v==="string") return v.split(/\s*,\s*/).filter(Boolean); return []; }
  function toYear(v) { const n = Number(String(v??"").trim()); return Number.isFinite(n) ? n : null; }
  function escapeHTML(s){ return toStr(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function attr(s){ return escapeHTML(s); }

  // ---------- Dataset normalization ----------
  function normalizeArray(data) {
    return (Array.isArray(data) ? data : []).map(x => ({
      title: toStr(x.title ?? x.paper_title),
      authors: toAuthors(x.authors),
      abstract: toStrOrNull(x.abstract),
      pdf_url: toStrOrNull(x.pdf_url ?? x.pdf),
      paper_url: toStrOrNull(x.paper_url ?? x.url),
      venue: toStrOrNull(x.venue ?? x.conference),
      year: toYear(x.year),
    }));
  }

  function setDataFromArray(arr, mode /* 'replace' | 'merge' */, label) {
    const normalized = normalizeArray(arr);
    if (mode === 'merge') {
      DATA = DATA.concat(normalized);
    } else {
      DATA = normalized;
    }
    buildIndex();
    applyFilters();
    if (label) elSources.textContent = `Loaded: ${label}`;
    elWarn.style.display = 'none';
    elWarn.textContent = '';
  }

  function downloadJSON(rows, filename) {
    const blob = new Blob([JSON.stringify(rows, null, 2)], {type: 'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename || `papers_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
  }

  // ---------- App state ----------
  let DATA = [];   // normalized records
  let VIEW = [];   // filtered/sorted
  let INDEX = [];  // search bags

  // ---------- UI refs ----------
  const elList = document.getElementById('list');
  const elWarn = document.getElementById('warning');
  const elCount = document.getElementById('count');
  const elSources = document.getElementById('sources');
  const elQ = document.getElementById('q');
  const elYear = document.getElementById('year');
  const elVenue = document.getElementById('venue');
  const elSort = document.getElementById('sort');
  const elLoad = document.getElementById('btnLoad');
  const elCSV = document.getElementById('btnCSV');
  const elClear = document.getElementById('btnClear');
  const elJson = document.getElementById('jsonUrl');
  const elLoading = document.getElementById('loading');
  const elSpin = document.getElementById('spin');

  function setLoading(on){ elLoading.style.display = on ? 'inline-flex' : 'none'; elSpin.style.display = on ? 'inline-block' : 'none'; }

  // ---------- Render ----------
  function renderList(rows){
    elList.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const art = document.createElement('article');
      art.className = 'card';
      art.innerHTML = `
        <div class="title">${escapeHTML(r.title || '(Untitled)')}</div>
        <div class="meta">
          ${r.year ? `<span>${r.year}</span>` : ''}
          ${r.venue ? `<span>• ${escapeHTML(r.venue)}</span>` : ''}
        </div>
        ${r.authors?.length ? `<div class="authors">${escapeHTML(r.authors.join(', '))}</div>` : ''}
        ${r.abstract ? `<div class="abs">${escapeHTML(r.abstract)}</div>` : ''}
        <div class="links">
          ${r.pdf_url ? `<a href="${attr(r.pdf_url)}" target="_blank" rel="noopener">PDF</a>` : ''}
          ${r.paper_url ? `<a href="${attr(r.paper_url)}" target="_blank" rel="noopener">Source</a>` : ''}
        </div>
      `;
      frag.appendChild(art);
    }
    elList.appendChild(frag);
    elCount.textContent = `${rows.length.toLocaleString()} results`;
  }

  // ---------- Index / search ----------
  function buildIndex(){
    INDEX = DATA.map(r => (toStr(r.title)+' '+toStr(r.abstract)+' '+toStr((r.authors||[]).join(' '))).toLowerCase());
    const years = Array.from(new Set(DATA.map(r => r.year).filter(Boolean))).sort((a,b)=>b-a);
    elYear.innerHTML = `<option value="">Year (all)</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join('');
    const venues = Array.from(new Set(DATA.map(r => r.venue).filter(Boolean))).slice(0,6);
    elSources.textContent = venues.length ? `Venues: ${venues.join(' · ')}` : '';
  }

  function scoreRow(idx, qTokens){
    if (!qTokens.length) return 0;
    const bag = INDEX[idx];
    let score = 0;
    for(const t of qTokens){
      if (!t) continue;
      const m = bag.split(t).length - 1;
      score += m;
      const title = toStr(DATA[idx].title).toLowerCase();
      if (title.includes(t)) score += 2;
    }
    return score;
  }

  function applyFilters(){
    const q = toStr(elQ.value).trim().toLowerCase();
    const yr = toStr(elYear.value).trim();
    const vn = toStr(elVenue.value).trim().toLowerCase();
    const sort = elSort.value;
    const qTokens = q ? q.split(/\s+/).filter(Boolean) : [];

    let rows = [];
    for (let i=0;i<DATA.length;i++){
      const r = DATA[i];
      if (yr && String(r.year) !== yr) continue;
      if (vn && !toStr(r.venue).toLowerCase().includes(vn)) continue;

      if (qTokens.length){
        const s = scoreRow(i, qTokens);
        if (s <= 0) continue;
        rows.push({row:r, s});
      } else {
        rows.push({row:r, s:0});
      }
    }

    // sort rows
    if (sort === 'relevance'){
      rows.sort((a,b)=> b.s - a.s);
    } else if (sort === 'year_desc'){
      rows.sort((a,b)=> (b.row.year||0) - (a.row.year||0));
    } else if (sort === 'year_asc'){
      rows.sort((a,b)=> (a.row.year||0) - (b.row.year||0));
    } else if (sort === 'title_asc'){
      rows.sort((a,b)=> toStr(a.row.title).localeCompare(toStr(b.row.title)));
    }

    VIEW = rows.map(x=>x.row);
    renderList(VIEW);
  }

  // ---------- CSV ----------
  function downloadCSV(rows){
    const header = ["title","year","venue","authors","pdf_url","paper_url","abstract"];
    const lines = [header.join(",")];
    for (const r of rows){
      const vals = [
        toStr(r.title),
        toStr(r.year),
        toStr(r.venue),
        toStr((r.authors||[]).join("; ")),
        toStr(r.pdf_url),
        toStr(r.paper_url),
        toStr(r.abstract)
      ].map(s => `"${toStr(s).replace(/"/g,'""')}"`);
      lines.push(vals.join(","));
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `papers_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  // ---------- Remote loading ----------
  async function loadJson(urlLike){
    const absUrl = urlLike.startsWith('http') ? urlLike
                    : (location.origin + (urlLike.startsWith('/') ? urlLike : '/'+urlLike));

    elWarn.style.display = 'none'; elWarn.textContent = '';
    setLoading(true); elJson.value = urlLike;

    try{
      const res = await fetch(absUrl, {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status} on ${absUrl}`);

      let data;
      try{
        data = await res.json();
      }catch(parseErr){
        const raw = await (await fetch(absUrl, {cache:'no-store'})).text();
        const sample = raw.slice(0,200).replace(/\n/g,' ');
        throw new Error(`JSON parse error: ${(parseErr && parseErr.message)||parseErr}. Sample: ${sample}`);
      }

      const mode = document.getElementById('mergeToggle').checked ? 'merge' : 'replace';
      setDataFromArray(data, mode, urlLike);
    }catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      console.error('[JSON load error]', msg);
      elWarn.textContent = `Failed to load JSON: ${msg}`;
      elWarn.style.display = 'block';
      DATA=[]; INDEX=[]; VIEW=[]; renderList([]);
    }finally{
      setLoading(false);
    }
  }

  // ---------- Events ----------
  function debounce(fn, ms=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  elQ.addEventListener('input', debounce(applyFilters, 120));
  elYear.addEventListener('change', applyFilters);
  elVenue.addEventListener('input', debounce(applyFilters, 120));
  elSort.addEventListener('change', applyFilters);
  document.getElementById('btnCSV').addEventListener('click', ()=> downloadCSV(VIEW.length ? VIEW : DATA));
  document.getElementById('btnDownloadJson').addEventListener('click', ()=> downloadJSON(VIEW.length ? VIEW : DATA, 'papers_export.json'));
  document.getElementById('btnClear').addEventListener('click', ()=>{ elQ.value=''; elYear.value=''; elVenue.value=''; elSort.value='relevance'; applyFilters(); });

  // URL load button
  document.getElementById('btnLoad').addEventListener('click', () => {
    const u = toStr(elJson.value).trim() || DEFAULT_JSON;
    loadJson(u + (u.includes('?') ? '&' : '?') + 'nocache=' + Date.now());
  });

  // Local file picker
  document.getElementById('jsonFile').addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const mode = document.getElementById('mergeToggle').checked ? 'merge' : 'replace';
      setDataFromArray(data, mode, `local file: ${file.name}`);
    } catch (err) {
      elWarn.textContent = `Failed to load local JSON: ${err && err.message ? err.message : err}`;
      elWarn.style.display = 'block';
    } finally {
      e.target.value = '';
    }
  });

  // Drag & drop
  const dz = document.getElementById('dropZone');
  ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#60a5fa'; }));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#2a2f3a'; }));
  dz.addEventListener('drop', async (e) => {
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const mode = document.getElementById('mergeToggle').checked ? 'merge' : 'replace';
      setDataFromArray(data, mode, `dropped: ${file.name}`);
    } catch (err) {
      elWarn.textContent = `Failed to load dropped JSON: ${err && err.message ? err.message : err}`;
      elWarn.style.display = 'block';
    }
  });

  // ---------- Boot ----------
  const DEFAULT_JSON = '/assets/projects/papers-explorer/all_2025_papers.json';
  (function boot(){
    const p = new URLSearchParams(location.search);
    const url = p.get('data') || DEFAULT_JSON;
    elJson.value = url;
    loadJson(url + (url.includes('?') ? '&' : '?') + 'nocache=' + Date.now());
  })();
  </script>
</body>
</html>
